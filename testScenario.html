<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossing Tester</title>
    <link rel="icon" href="assets/images/favicon_highway.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>

    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #f4f6f7;
            --text-color: #2c3e50;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --input-border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        #canvas {
            flex: 1;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        #actors {
            width: 50%;
            height: 100%;
            overflow: auto;
        }

        #controls {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #crossingSource {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--input-border-color);
            border-radius: 6px;
            font-size: 1rem;
            appearance: none;
            background-color: white;
        }

        fieldset {
            border: 1px solid var(--input-border-color);
            border-radius: 6px;
            padding: 1rem;
        }

        legend {
            padding: 0 0.5rem;
            color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        #explanation {
            background-color: #f1f4f8;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        #uitleg, #regel {
            display: block;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
            }

            #actors, #canvas {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Contains the scenario visualiser -->
    <div id="canvas"></div>

    <div style="display:flex; height:100vh;" id="actors">
        <!-- Contains all control elements to build a scenario -->
        <div id="controls">

            <select onchange="changeScenario()" id="crossingSource">
                <option value="" disabled selected>Selecteer een scenario</option>
            </select>

            <form onsubmit="checkAnswer(event)">
                <fieldset id="test" disabled>
                    <legend id="question"><b>Welke weggebruiker gaat eerst?</b></legend>
                    <div id="answers">
                    </div>
                    <div>
                        <br>
                        <button type="submit">Controleer antwoord</button>
                    </div>
                </fieldset>
            </form>
            <div id="explanation" style="display:none;">
                <p id="uitleg"></p>
                <span id="regel"></span>
            </div>
        </div>
    </div>

    <script>
        // Main data object
        let data = {
            "scenario_name": "",
            "background": "",
            "actors": [],
            "interactions": []
        };

        // Sets up the scenario visualiser
        function setup() {
            let canvas = createCanvas(1000, 1000);
            canvas.parent('canvas');
            angleMode(DEGREES);
        }

        // Main visualiser variables
        let crossingImg = null;
        // Main draw loop
        function draw() {
            // Draw the background and current crossing image
            background(220);
            if (crossingImg) image(crossingImg, 0, 0, width, height);

            // Draw all the actors in the data object
            data.actors.forEach(actor => {
                // Draw the destination arrow for the actor
                if (actor.destination) drawArrow(actor.x, actor.y, actor.destination.x, actor.destination.y);

                // Find the corresponding actor image, then place it according the the position and rotation
                let tempImg = actorImgs.find((item) => item.type == actor.type).img;
                push();
                translate(actor.x, actor.y);
                rotate(actor.rotation);
                image(tempImg, -tempImg.width / 2, -tempImg.height / 2);
                pop();

                // Draw the actor ID for identification
                fill(255);
                stroke(0);
                strokeWeight(2);
                textSize(25);
                text(`${actor.id}`, actor.x - 7, actor.y + 5);
                noStroke();
            });

        }

        // -------------HELPERS-----------------------------------------------------------------

        function checkAnswer() {
            event.preventDefault();
            // TODO: add reloading behaviour
            // document.getElementById('crossingSource').disabled = false;
            document.getElementById('explanation').style.display = 'block';
        }

        function changeScenario() {
            let scenario = document.getElementById('crossingSource').value;
            fetch(`./assets/scenarios/${scenario}`)
                .then((response) => response.json())
                .then((json) => {
                    data = json;
                    crossingImg = loadImage(data.background);

                    let answersDOM = document.getElementById('answers');
                    data.actors.forEach((actor) => {
                        let tempRadio = document.createElement('input');
                        tempRadio.type = "radio";
                        tempRadio.id = `actor${actor.id}`;
                        tempRadio.name = "actors";
                        tempRadio.value = actor.id;
                        answersDOM.append(tempRadio);
                        let tempLabel = document.createElement('label');
                        tempLabel.for = `actor${actor.id}`;
                        tempLabel.innerHTML = `Weggebruiker ${actor.id}`;
                        answersDOM.append(tempLabel);
                        answersDOM.append(document.createElement('br'));
                    });

                    document.getElementById('uitleg').innerHTML = `Weggebruiker ${data.interactions[0].winner} mag eerst:`;
                    document.getElementById('regel').innerHTML = `${data.interactions[0].reason}`;

                });

            document.getElementById('crossingSource').disabled = true;
            document.getElementById('test').disabled = false;
        }

        // Draw the destination arrow to indicate where actors want to travel to
        function drawArrow(startX, startY, endX, endY) {
            // Calculate the angle and length of the arrow
            let angle = atan2(endY - startY, endX - startX);
            let distance = dist(startX, startY, endX, endY);

            // Draw the angle at the start coordinates
            push();
            translate(startX, startY);
            rotate(angle);

            stroke(0);
            strokeWeight(2);
            line(0, 0, distance, 0);

            // Draw the arrow head at the destination coordinates using the calculated vector
            fill(0);
            noStroke();
            beginShape();
            vertex(distance, 0);
            vertex(distance - 10, -5);
            vertex(distance - 10, 5);
            endShape(CLOSE);
            pop();
        }

        // Define actor image variable to house all actor image objects
        let actorImgs = [];
        // Load data before the visualiser is started
        function preload() {

            // Load all actor images and put the in an image array for easy access
            actorImgs.push({
                "type": "voetganger",
                "img": loadImage('./assets/images/voetganger.png')
            });
            actorImgs.push({
                "type": "fietser",
                "img": loadImage('./assets/images/fietser.png')
            });
            actorImgs.push({
                "type": "auto1",
                "img": loadImage('./assets/images/auto1.png')
            });

            fetch('./assets/scenarios/scenarios.json')
                .then((response) => response.json())
                .then((json) => {
                    let crossingSelector = document.getElementById('crossingSource');
                    json.forEach((scenario) => {
                        let tempOption = document.createElement('option');
                        tempOption.value = scenario.file;
                        tempOption.innerHTML = scenario.scenario_name;
                        crossingSelector.appendChild(tempOption);
                    });
                });
        }

    </script>

</body>

</html>